---
title: 《大规模Web服务开发技术》读书笔记
date: 2017-03-15 13:15:49
tags: Web
categories: 读书笔记
---

> 开始从事WEB后端方面开发了，准备从[《大规模Web服务开发技术》](https://book.douban.com/subject/6758780/)获取一些知识。在看这本书的过程中确实也学到了不少，不过实际工作中服务器这块因为业务，需求之类并没有这么多，所以很多知识了解了下，甚是遗憾。  

<!--more-->

## 大数据处理
>  简单来说，当一台服务器无法承担负载时，都会采用横向扩展（scale out）或者纵向扩展（scale up）。横向扩展就是通过服务器的数量来分担负载，纵向扩展是通过提高硬件的性能来处理负载。 

- 难点 
内存有限，磁盘补位。一般磁盘瓶颈在于寻道与SSD瓶颈在于总线速度与其他一些架构。
- 寻找瓶颈的流程 
  1. 查找平均负载
    top，uptime查看系统整体情况；
  2. 确认CPU，I/O是否有瓶颈
    CPU负载：
       * top，sar 确认是用户进程还是系统进程
       * ps查看进程状态
       * strace或oporate进行追踪
    I/O负载：
       * ps查看是否有大量消耗内存
       * 程序问题改，内存不够加
- 扩展性 
  1. CPU
    增加服务器，负载均衡，优化程序 
  2. I/O
    数据库，算法
- 处理大规模数据的基础知识
    1. 程序优化
        * 部分数据放入内存，将磁盘寻道次数降低；
        * 可以实现分布式，利用局部性；
        * 优化数据结构与算法；
        * 数据压缩，信息搜索技术；
    2. 系统层面
        * 操作系统的缓存
        * 以分布式为前提的RDBMS应用
        * 算法和数据结构
    
## 操作系统的缓存和分布式 
> 操作系统(Linux)缓存先进行处理，数据量进一步增大时，再考虑分布式。 

- 操作系统缓存机制 
    1. 内存与虚拟内存 
        操作系统将内核中的内存抽象化，以页面(4KB)为单位分配物理内存并管理。实际上是当物理内存不够时,将部分不常用数据放到磁盘中。
        **页面=虚拟内存的最小单位**
    2. 页面缓存原理 
        进程无法直接访问磁盘，所以访问(虚拟)内存。内核分配过的内存不会释放，而是一直保留下来，这就是页面缓存原理，一般通过VFS来实现。在内存不充足的情况下，采用LRU策略，即读新去老。
- 利用局部性的分布式 
    1. 局部分布式 
        根据访问模式实施分布式，不同的机器缓存不同内容。
    2. Partitioning(分区) 
        Partitioning就是将一个数据库分割到多台服务器上，比如“以表为单位进行分割”。
    3. 根据访问模式分割成”岛“
        比如将爬虫与用户请求分开，将爬虫的请求单独放到岛上。
- 以页面缓存为基础的运维基本原则 
    1. 操作系统刚启动时不要将服务器投入生产环境，以防大规模请求造成内存紧张。
    2. 性能测试要在缓存优化后进行。

## 数据库的横向扩展策略 
- 分布式MySQL应用要点
    1. 灵活应用操作系统缓存
        考虑全部数据量，尽量让数据量小于物理内存(感觉不可能，笑)。设计表结构的时候要考虑属性大小，比如年龄，最多三位数字，可以使用smallint。
    2. 正确设置索引
        [MySQL索引背后的数据结构及算法原理](http://blog.codinglabs.org/articles/theory-of-mysql-index.html)，简单来讲与二叉树相比，B树保证每个节点都保存在一个块中，B+则是进一步优化。索引不仅改善复杂度O(logn)，还能改善寻道次数。
    3. MySQL的分布式 
        即主从，主库压力可以分表或交给NoSQL。
- MySQL横向扩展和Partitioning 
    1. 避免join--利用where...in...
    2. 4从1主
    
## 处理大规模数据时代码重点 
>  从RDBMS(关系型数据库)中提取数据，建立索引服务器之类的东西，再让Web应用通过RPC(远程过程调用)，Web API(JSON+HTTP)等访问索引服务器。

- 特殊用途索引
   定期取出数据，并根据数据来创建索引，比如搜索用的逆向索引，关键字链接用Trie等。
    
## 压缩编程
> 需要考虑的是数据大小和I/O加速之间的关系，以紧凑，简洁方式保存整数数据  

- 可变字节码 
    二进制编码，去掉前半部分的x余，以最少的字节表示信息，这就是可变字节码。已经排序的序列是递增的，可以以“差”存储已排序的整数。如**[3, 5, 20]** -> **[3, 2, 15]**。由此做到先计算差，再编码为可变字节码。
- 压缩 
    压缩原理是根据符号的概率分布，给出现频率高的分配较短的编码。
，给出现频率低的分配较长的编码。

## 算法实用化

    数据结构是数组、树结构等存储或表现对象数据的结构。对于算法，必须依照算法中的常用操作选择数据结构。
    常数项指算法实现中不依赖于输入大小，但却不得不执行的操作。如if分支等等。比如说快排相对其他O(nlogn)快，是因为快排特点使得CPU缓存容易生效。

## 全文搜索技术
> 逆向索引 = 字典文件 + 置入文件

- 搜索系统的架构
    搜索系统的一般步骤：爬行->存储->建立索引->搜索->评分->显示结果。
- 全文搜索种类
    书中一共是介绍了三种：grep类型、后缀类型、逆向索引类型。
    * grep类型
        从头开始读取搜索对象，即时性良好，查询扩展容易，非主流。
    * 后缀类型
        用可搜索的形式存储搜索对象的全文，如Trie等，非主流。
    * 逆向索引类型
        逆向索引先要在文档之外另行创建逆向索引，建立term和文档的关系。所有term的集合称为字典，逆向索引左字典，右文档。term右边放的是存在该term的文档，所以搜索时按照term进行搜索。
- 字典的创建方法
    * 将单词当作term处理
        1. 字典+Aho-Corasick算法
        2. 语素分析
            推测词性->创建字典(能预测字典中没有的单词)->考虑单词排序(对单词排序进行机器学习)->可以自定义字典。
            
## WEB后台
> WEB服务基础设施三要点：低成本高效率；重视可扩展性、响应性方面的设计；重视开发速度；

- 基础组成
    从技术模型上讲，有垂直结合模型和水平分散模型两个概念。垂直结合模型指从物理层到最上层的服务设计完全由同一公司构建，比如阿里云全家桶。水平分散模型就是各层由不同企业的系统提供，作为一个整体来构建系统。

## 保证冗余性和系统稳定性
> 最终的是去除SPOF(单点故障)
    
-  保证冗余性
    开端做法事增加服务器，保证处理能力。一般应对服务器故障，策略就是负载均衡器实现失败转移(failover)和失败恢复(failback),让故障服务器自动下线。失败转移就是使其自动离线，失败恢复就是让恢复正常的服务器再次上线。负载均衡器对服务器定期检查，判断服务器状况，这是最基本的冗余性。

- 系统稳定化与对策
    稳定性与资源利用率，与速度之间需要权衡。实际一般是维持适当余量和消灭不稳定因素。

## 提高硬件资源的使用率

- 虚拟化技术
    加入主要利用空闲资源的虚拟机操作系统，cpu空闲->Web服务器；I/O空闲->数据库服务器;内存空闲->缓存服务器。资源消耗类似的，要避免组合在一起使用。

## WEB服务和网络

- 网络架构的层次化(三层架构)
    访问层(百台)->分发层(千台)->核心层(万台)。
- 超越10Gbps
    获取AS编号；连接IX进行流量控制；用BGP控制路由。


